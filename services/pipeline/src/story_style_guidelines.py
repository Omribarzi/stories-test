"""
הנחיות סגנון ליצירת סיפורי ילדים - למניעת סיפורים מטיפים וחינוכיים מדי
"""

STORY_STYLE_GUIDELINES = """
# עקרונות יצירת סיפור איכותי לילדים

## 1. Show, Don't Tell - הראה, אל תסביר
❌ לא טוב: "ליאור הבין שמשחק הוגן הוא חשוב"
✅ טוב: "ליאור הסתכל על החברים שלו שצוחקים ביחד, והרגיש פתאום קל יותר"

❌ לא טוב: "הוא למד שחברות חשובה מניצחון"
✅ טוב: "הליצן של עומר גרם לליאור לשכוח מהאוצר. זה היה הרבה יותר כיף"

## 2. דיאלוגים טבעיים - ילדים מדברים כמו ילדים
❌ לא טוב: "זה בסדר לטעות, אבל צריך לשחק לפי החוקים. זה מה שעושה את המשחק כיף"
✅ טוב: "אה, קצת רימית... זה לא כיף ככה"

❌ לא טוב: "אני ממש שמח שאתה החבר שלי"
✅ טוב: "וואו! איך עשית את זה?!"

## 3. מורכבות רגשית - רגשות לא שחור-לבן
❌ לא טוב: "ליאור הרגיש שמח"
✅ טוב: "ליאור רצה לצעוק משמחה, אבל גם הרגיש משהו מצמרר בבטן - כאילו אכל משהו לא טוב"

❌ לא טוב: "הוא הרגיש רע עם עצמו"
✅ טוב: "הפנים שלו התחממו. הוא בדק אם מישהו מסתכל עליו"

## 4. פרטים חושיים וקונקרטיים
❌ לא טוב: "הם שיחקו במשחק"
✅ טוב: "הקוביה קפצה על הדשא והתגלגלה עד שעצרה על 6. נועה צרחה כל כך חזק שציפורים עפו מהעץ"

## 5. הימנע ממסרים מפורשים
❌ לא טוב: "ליאור הבין שמשחק הוגן פירושו לשחק לפי החוקים, לא לרמות, להודות בטעויות"
✅ טוב: "בסוף המשחק, כשכולם לחצו ידיים, ליאור חייך. זה היה ממש טוב"

❌ לא טוב: "החברים שלי יותר חשובים מכל ניצחון"
✅ טוב: "ליאור ראה את עומר מנסה לעשות בועות מהמים שלו וצחק. מי צריך אוצר?"

## 6. קונפליקטים אמיתיים - לא פתרונות מהירים
❌ לא טוב: "אתם צודקים, סליחה" ואז הכל חוזר להיות מושלם
✅ טוב: תן לזה לקחת זמן - אי נוחות, שקט מביך, ואז לאט לאט דברים משתפרים

## 7. דמויות עם עומק
❌ לא טוב: דמויות שמלמדות מוסר ("זה בסדר לטעות, אבל...")
✅ טוב: דמויות עם התנהגויות אמיתיות - מישהו מסנוור מהשמש, מישהו קושר שרוך, מישהו רעב

## 8. הומור וקלילות - במיוחד מגיל 6+
- הוסף רגעים מצחיקים שלא קשורים למסר
- תן לדמויות להיות מצחיקות בלי כוונה
- השתמש בפיזיות (מעידות, דברים נופלים, צלילים מוזרים)

## 9. פעולות ותנועות במקום הרהורים
❌ לא טוב: "ליאור חשב על היום. הוא הבין ש..."
✅ טוב: "ליאור בעט בחצץ בדרך לכיתה. קפץ פעמיים על רגל אחת. קפץ שלוש על השנייה"

## 10. תן לקורא להסיק מסקנות בעצמו
- אל תסביר מה הדמות למדה
- אל תסכם את המסר
- תן לסיום להיות רגע קטן ומשמעותי, לא הצהרה

---

## כללים לפי גיל:

### גיל 4-5:
- יותר חזרתיות
- משפטים קצרים
- מסרים יכולים להיות יותר ישירים (אבל עדיין לא הטפה!)

### גיל 6-7:
- פחות הסברים
- יותר הומור
- יותר פרטים מעניינים
- תן לילדים להבין בעצמם

### גיל 8+:
- אפס הטפה
- מורכבות רגשית אמיתית
- סוף לא חייב להיות "שמח ומושלם"
- תת-עלילות ודמויות משניות

---

## דוגמה מעשית:

**רע (מטיף):**
"ליאור למד שחשוב לשתף. הוא הבין שכשהוא נותן לאחרים, גם הוא מרגיש טוב. החברים שלו שמחו והוא שמח. כולם למדו שחשוב לשתף."

**טוב (סיפורי):**
"ליאור הושיט לנועה חצי מהכריך. היא נגסה ביס ענק שגרם לחצי השני כמעט ליפול. הם שנייהם פרצו בצחוק, וליאור כבר לא הרגיש את הרעב בבטן. משהו אחר הרגיש מלא."
"""


# Age-specific quantitative parameters matrix
AGE_PARAMS = {
    2: {"pages": 8,  "words_per_page": "15-25", "sentences_per_page": "1-2", "max_words_per_sentence": 8,  "words_per_line": 3, "font_base": 24},
    3: {"pages": 13, "words_per_page": "20-35", "sentences_per_page": "1-2", "max_words_per_sentence": 10, "words_per_line": 3, "font_base": 24},
    4: {"pages": 14, "words_per_page": "25-40", "sentences_per_page": "2-3", "max_words_per_sentence": 10, "words_per_line": 4, "font_base": 24},
    5: {"pages": 16, "words_per_page": "30-50", "sentences_per_page": "2-3", "max_words_per_sentence": 12, "words_per_line": 4, "font_base": 22},
    6: {"pages": 17, "words_per_page": "40-60", "sentences_per_page": "2-3", "max_words_per_sentence": 14, "words_per_line": 5, "font_base": 22},
    7: {"pages": 19, "words_per_page": "40-60", "sentences_per_page": "2-4", "max_words_per_sentence": 14, "words_per_line": 5, "font_base": 20},
    8: {"pages": 19, "words_per_page": "40-60", "sentences_per_page": "2-4", "max_words_per_sentence": 14, "words_per_line": 6, "font_base": 20},
}


def get_age_params(age: int) -> dict:
    """
    מחזיר פרמטרים כמותיים לפי גיל.
    אם הגיל לא קיים במטריצה, משתמש בגיל הקרוב ביותר.
    """
    age = max(2, min(8, age))
    return AGE_PARAMS[age]


def get_style_prompt_for_age(age: int) -> str:
    """
    מחזיר הנחיות סגנון ספציפיות לגיל — כולל פרמטרים כמותיים וכללי סגנון
    """
    params = get_age_params(age)

    quantitative = f"""
=== פרמטרים כמותיים לגיל {age} (חובה!) ===
- עמודים בספר: {params['pages']}
- מילים בכל עמוד: {params['words_per_page']}
- משפטים בכל עמוד: {params['sentences_per_page']}
- מקסימום מילים במשפט: {params['max_words_per_sentence']}
- מקסימום מילים בשורה (לצורך רינדור): {params['words_per_line']}
"""

    base_rules = """
כללי סגנון חובה:
1. Show, don't tell - הראה רגשות במקום להסביר אותם
2. דיאלוגים טבעיים - ילדים מדברים בפשטות, לא בהטפות
3. פרטים חושיים - צבעים, קולות, ריחות, תנועות
4. אפס מסרים מפורשים - תן לקורא להבין בעצמו
5. פעולות במקום מחשבות - מה הדמויות עושות, לא מה הן חושבות
"""

    if age <= 3:
        return quantitative + base_rules + """
6. משפטים קצרים מאוד ופשוטים
7. חזרתיות רבה — מבנה חוזר בכל עמוד
8. מילים מוכרות מעולם הילד (אוכל, חיות, צבעים, משפחה)
9. רגשות בסיסיים וברורים — שמח, עצוב, מפוחד
10. פעולות פיזיות פשוטות — קפיצה, ריצה, חיבוק
"""
    elif age <= 5:
        return quantitative + base_rules + """
6. משפטים קצרים ופשוטים
7. חזרתיות בונה ביטחון
8. מסר יכול להיות עדין אבל לא הטפה ישירה
9. דיאלוגים קצרים וישירים
"""
    elif age <= 7:
        return quantitative + base_rules + """
6. הוסף הומור וקלילות
7. פחות הסברים — תן לילדים להבין
8. דמויות עם אישיות אמיתית, לא מורים מחופשים
9. רגעים מצחיקים שלא קשורים למסר
10. דיאלוגים ארוכים יותר ומגוונים
"""
    else:  # 8+
        return quantitative + base_rules + """
6. אפס הטפה — כלל ברזל
7. מורכבות רגשית — רגשות מעורבים ולא ברורים
8. הומור ואירוניה
9. סוף לא חייב להיות מושלם
10. תת-עלילות ופרטים עשירים
11. דמויות משניות עם אישיות
"""


def validate_story_not_preachy(story_text: str) -> list:
    """
    בודק אם הסיפור מכיל ביטויים מטיפים ומחזיר אזהרות.
    משתמש בביטויים ספציפיים שמעידים על הטפה, לא גזעי מילים כלליים.
    """
    import re

    # Exact preachy patterns — these almost always indicate moralizing
    exact_phrases = [
        "הבין ש",
        "הבינה ש",
        "למד ש",
        "למדה ש",
        "גילה ש",
        "גילתה ש",
        "זה מלמד",
        "המסר הוא",
        "ולמדו שיעור",
        "למדו שיעור",
        "חשוב לזכור ש",
        "חשוב להבין ש",
        "צריך לזכור ש",
        "צריך להבין ש",
        "המוסר של",
        "והמוסר הוא",
    ]

    # Regex patterns for narrator moralizing (not dialogue)
    regex_patterns = [
        (r"הבין כי\s", "הבין כי"),
        (r"למד כי\s", "למד כי"),
        (r"הבינו ש", "הבינו ש"),
        (r"למדו ש", "למדו ש"),
    ]

    warnings = []
    for phrase in exact_phrases:
        if phrase in story_text:
            warnings.append(f"⚠️  נמצא ביטוי מטיף: '{phrase}'")

    for pattern, label in regex_patterns:
        if re.search(pattern, story_text):
            warnings.append(f"⚠️  נמצא ביטוי מטיף: '{label}'")

    return warnings
